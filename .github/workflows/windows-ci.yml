name: Windows CI Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        variant: [debug, profile, release]

    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."

      - name: Clone repository
        uses: actions/checkout@v4
        with:
          # Shallow clone to avoid pulling full history and old/unused large LFS files
          fetch-depth: 1
          lfs: true
          submodules: recursive

      - name: Read Vulkan SDK version
        id: vkver
        shell: pwsh
        run: |
          $ver = (Get-Content "env/vulkan-sdk-version.txt" -Raw).Trim()
          if ([string]::IsNullOrWhiteSpace($ver)) { throw "ci/vulkan-sdk-version.txt is empty" }
          "ver=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Restore Vulkan SDK from cache
        id: vulkan-sdk
        uses: actions/cache@v4
        with:
          path: C:\dep\vulkan-sdk\${{ steps.vkver.outputs.ver }}
          key: ${{ runner.os }}-vulkan-sdk-${{ steps.vkver.outputs.ver }}

      - name: Download + unzip Vulkan SDK (cache miss)
        if: steps.vulkan-sdk.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ver = "${{ steps.vkver.outputs.ver }}"
          $zipName = "vulkan-sdk-for-windows-$ver.zip"
          $url = "https://github.com/randomgraphics/vulkan-sdk-for-windows/releases/download/v$ver/$zipName"

          New-Item -ItemType Directory -Force -Path C:\dep\vulkan-sdk\${{ steps.vkver.outputs.ver }} | Out-Null
          $tmpZip = Join-Path $env:RUNNER_TEMP $zipName

          Write-Host "Downloading $url"
          Invoke-WebRequest -Uri $url -OutFile $tmpZip -UseBasicParsing

          Write-Host "Extracting to C:\dep\vulkan-sdk\${{ steps.vkver.outputs.ver }}"
          Expand-Archive -Path $tmpZip -DestinationPath C:\dep\vulkan-sdk\${{ steps.vkver.outputs.ver }} -Force

      - name: Install Python Packages
        run: python.exe -m pip install --upgrade termcolor

      - name: Build
        shell: powershell
        run: |
          $env:VULKAN_SDK="C:\dep\vulkan-sdk\${{ steps.vkver.outputs.ver }}\vulkan-sdk-for-windows"
          . env\garnet.ps1
          b ${{ matrix.variant }}

      - run: echo "üçè This job's status is ${{ job.status }}."